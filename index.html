<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>K8s Reclaim Policy Simulator (Retain • Delete • Recycle)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    body { font-family: 'Geist', ui-sans-serif, system-ui; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    .float { animation: float 6s ease-in-out infinite; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-950 dark:text-gray-200 min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';

    const { Database, Box, Trash2, RefreshCw, CheckCircle2, XCircle, AlertCircle, ArrowDown, Eraser, Lock, RotateCcw, Sun, Moon, Info } = lucide;

    const RECLAIM_POLICIES = {
      Retain: { color: "amber", desc: "Data kept. PV becomes Released. Manual cleanup required." },
      Delete: { color: "red", desc: "PV + underlying storage automatically deleted." },
      Recycle: { color: "purple", desc: "[Deprecated] PV scrubbed and becomes Available again." }
    };

    function K8sStorageSimulator() {
      const [darkMode, setDarkMode] = useState(false);
      const [reclaimPolicy, setReclaimPolicy] = useState("Retain");
      const [pv, setPv] = useState(null);
      const [pvcs, setPvcs] = useState([]);
      const [logs, setLogs] = useState([]);
      const [step, setStep] = useState(0);

      const addLog = (msg, type = "info") => {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        setLogs(prev => [{time, msg, type, id: Date.now()}, ...prev].slice(0, 12));
      };

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }, [darkMode]);

      const createPV = () => {
        if (pv) return;
        const newPv = {
          name: "pv-data-01",
          capacity: 20,
          storageClass: "standard",
          accessModes: ["ReadWriteOnce"],
          labels: { environment: "production" },
          status: "Available",
          claimRef: null,
          reclaimPolicy
        };
        setPv(newPv);
        addLog(`Created PV ${newPv.name} (ReclaimPolicy: ${reclaimPolicy})`, "success");
      };

      const createPVC = () => {
        const newPvc = {
          id: `pvc-${Date.now().toString(36)}`,
          name: `app-data-${pvcs.length + 1}`,
          request: 8,
          storageClass: "standard",
          accessModes: ["ReadWriteOnce"],
          selector: { environment: "production" },
          status: "Pending",
          boundTo: null
        };
        setPvcs(prev => [...prev, newPvc]);
        addLog(`Created PVC ${newPvc.name} [Pending]`, "info");
      };

      const deletePVC = (pvcToDelete) => {
        if (pvcToDelete.status !== "Bound") {
          setPvcs(prev => prev.filter(p => p.id !== pvcToDelete.id));
          addLog(`Deleted unbound PVC ${pvcToDelete.name}`, "warning");
          return;
        }

        const policy = pv.reclaimPolicy;

        if (policy === "Delete") {
          addLog(`ReclaimPolicy=Delete → Deleting PV + underlying storage...`, "warning");
          setPv(null);
        } else if (policy === "Recycle") {
          addLog(`ReclaimPolicy=Recycle → Scrubbing PV... → Available`, "info");
          setPv(prev => ({ ...prev, status: "Available", claimRef: null }));
        } else { // Retain
          addLog(`ReclaimPolicy=Retain → PV becomes Released. Data preserved.`, "warning");
          setPv(prev => ({ ...prev, status: "Released", claimRef: pvcToDelete.id }));
        }

        setPvcs(prev => prev.map(p => p.id === pvcToDelete.id ? { ...p, status: "Terminated" } : p));
        addLog(`PVC ${pvcToDelete.name} deleted`, "warning");

        setTimeout(() => {
          setPvcs(prev => prev.filter(p => p.id !== pvcToDelete.id));
        }, 1500);
      };

      const recycleOrClearPV = () => {
        if (!pv || pv.status !== "Released") return;
        setPv(prev => ({ ...prev, status: "Available", claimRef: null }));
        addLog(`Admin: Cleared ClaimRef → PV Available again`, "success");
      };

      const resetCluster = () => {
        setPv(null);
        setPvcs([]);
        setLogs([]);
        setStep(0);
        addLog("Cluster reset", "info");
      };

      // Controller reconciliation loop
      useEffect(() => {
        const interval = setInterval(() => {
          if (!pv || pvcs.length === 0 || pv.status !== "Available") {
            setStep(0);
            return;
          }

          const pendingPvc = pvcs.find(p => p.status === "Pending");
          if (!pendingPvc) {
            setStep(6);
            return;
          }

          // Matching logic
          let current = 0;
          if (pv.storageClass === pendingPvc.storageClass) current = 1;
          if (pv.accessModes[0] === pendingPvc.accessModes[0]) current = 2;
          if (pv.capacity >= pendingPvc.request) current = 3;
          if (pv.labels.environment === pendingPvc.selector.environment) current = 4;

          setStep(current);

          if (current === 4) {
            setTimeout(() => {
              setPv(prev => ({ ...prev, status: "Bound", claimRef: pendingPvc.id }));
              setPvcs(prev => prev.map(p => p.id === pendingPvc.id ? { ...p, status: "Bound", boundTo: pv.name } : p));
              addLog(`Bound PVC ${pendingPvc.name} → PV ${pv.name}`, "success");
              setStep(6);
            }, 800);
          }
        }, 800);

        return () => clearInterval(interval);
      }, [pv, pvcs]);

      const getStatusBadge = (status) => {
        const map = {
          Available: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
          Bound: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
          Released: "bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200",
          Pending: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",
        };
        return map[status] || "bg-gray-200 text-gray-600";
      };

      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="bg-gray-900 text-white p-4 shadow-xl">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Database className="w-8 h-8 text-cyan-400" />
                <h1 className="text-2xl font-bold">
                  Kubernetes Reclaim Policy Simulator
                </h1>
              </div>
              <div className="flex items-center gap-4">
                <button onClick={() => setDarkMode(!darkMode)} className="p-2 hover:bg-white/10 rounded-lg">
                  {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                </button>
                <button onClick={resetCluster} className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">
                  <RotateCcw className="w-4 h-4" /> Reset
                </button>
              </div>
            </div>
          </header>

          <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
            {/* Left Sidebar */}
            <aside className="w-full lg:w-80 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 p-6 space-y-6 overflow-y-auto">
              <div>
                <h3 className="text-sm font-bold uppercase text-gray-500 dark:text-gray-400 mb-3">Reclaim Policy</h3>
                <div className="grid grid-cols-1 gap-3">
                  {Object.entries(RECLAIM_POLICIES).map(([policy, {color, desc}]) => (
                    <label key={policy} className={`block p-4 rounded-lg border-2 cursor-pointer transition-all ${reclaimPolicy === policy ? `border-${color}-500 bg-${color}-50 dark:bg-${color}-900/20` : 'border-gray-300 dark:border-gray-700'}`}>
                      <input type="radio" name="policy" checked={reclaimPolicy === policy} onChange={() => setReclaimPolicy(policy)} className="sr-only" />
                      <div className="flex items-start gap-3">
                        <div className={`w-5 h-5 rounded-full border-2 ${reclaimPolicy === policy ? `border-${color}-600 bg-${color}-600` : 'border-gray-400'}`} />
                        <div>
                          <div className="font-semibold">{policy}</div>
                          <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">{desc}</div>
                        </div>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className="space-y-3">
                <h3 className="text-sm font-bold uppercase text-gray-500 dark:text-gray-400">Actions</h3>
                <button onClick={createPV} disabled={!!pv} className="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 text-white rounded-lg flex items-center justify-center gap-2">
                  <Database className="w-5 h-5" /> Create PV (20Gi)
                </button>
                <button onClick={createPVC} disabled={!pv || pv.status !== "Available"} className="w-full py-3 px-4 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-300 text-white rounded-lg flex items-center justify-center gap-2">
                  <Box className="w-5 h-5" /> Create PVC (8Gi)
                </button>
                {pv?.status === "Released" && reclaimPolicy === "Retain" && (
                  <button onClick={recycleOrClearPV} className="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg flex items-center justify-center gap-2">
                    <Eraser className="w-5 h-5" /> Clear ClaimRef (Admin)
                  </button>
                )}
              </div>

              <div className="bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                <h3 className="text-sm font-bold mb-3 flex items-center gap-2">
                  <Info className="w-4 h-4" /> Current Policy: <span className={`text-${RECLAIM_POLICIES[reclaimPolicy].color}-600`}>{reclaimPolicy}</span>
                </h3>
                <p className="text-xs text-gray-600 dark:text-gray-400 leading-relaxed">
                  {reclaimPolicy === "Retain" && "Data is preserved after PVC deletion. PV becomes Released and cannot be reused until manually cleaned."}
                  {reclaimPolicy === "Delete" && "Most cloud providers delete the disk automatically. Common in production."}
                  {reclaimPolicy === "Recycle" && "Deprecated. PV is scrubbed and reused. Rarely used today."}
                </p>
              </div>
            </aside>

            {/* Main Canvas */}
            <main className="flex-1 bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-950 dark:to-black p-8 overflow-y-auto">
              <div className="max-w-5xl mx-auto space-y-12">
                {/* PV */}
                <div className="flex justify-center">
                  <div className={`w-96 p-6 rounded-2xl shadow-2xl border-4 transition-all duration-1000 ${pv ? getStatusBadge(pv.status) + ' border-opacity-100' : 'border-dashed border-gray-400'}`}>
                    {pv ? (
                      <>
                        <div className="flex justify-between items-center mb-4">
                          <h2 className="text-xl font-bold flex items-center gap-2"><Database className="w-6 h-6" /> {pv.name}</h2>
                          <span className="text-xs font-bold px-3 py-1 rounded-full bg-black/10">{pv.status}</span>
                        </div>
                        <div className="space-y-2 text-sm">
                          <div><strong>Capacity:</strong> {pv.capacity}Gi</div>
                          <div><strong>Reclaim Policy:</strong> <span className={`font-bold text-${RECLAIM_POLICIES[pv.reclaimPolicy].color}-600`}>{pv.reclaimPolicy}</span></div>
                          {pv.claimRef && <div className="mt-3 p-3 bg-red-100 dark:bg-red-900/30 rounded border border-red-400 text-red-800 dark:text-red-300 text-xs font-mono"><Lock className="w-4 h-4 inline" /> ClaimRef: {pv.claimRef}</div>}
                        </div>
                      </>
                    ) : (
                      <div className="text-center text-gray-500 py-12">No PV Created</div>
                    )}
                  </div>
                </div>

                {/* Connection */}
                <div className="flex justify-center">
                  <div className="h-32 w-1 relative">
                    <div className={`absolute inset-0 w-1 bg-gradient-to-b ${pv?.status === 'Bound' ? 'from-green-500 to-green-400' : 'from-gray-400 to-gray-500'}`} />
                    {step > 0 && step < 5 && <ArrowDown className="absolute top-8 left-1/2 -translate-x-1/2 w-8 h-8 text-blue-500 animate-bounce" />}
                    {step === 6 && <CheckCircle2 className="absolute top-10 left-1/2 -translate-x-1/2 w-10 h-10 text-green-500" />}
                  </div>
                </div>

                {/* PVCs */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {pvcs.map(pvc => (
                    <div key={pvc.id} className={`p-5 rounded-xl shadow-lg border-2 ${getStatusBadge(pvc.status)} transition-all`}>
                      <div className="flex justify-between items-start mb-3">
                        <h3 className="font-bold flex items-center gap-2"><Box className="w-5 h-5" /> {pvc.name}</h3>
                        <button onClick={() => deletePVC(pvc)} className="text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 p-1 rounded">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                      <div className="text-xs space-y-1">
                        <div><strong>Request:</strong> {pvc.request}Gi</div>
                        <div><strong>Status:</strong> {pvc.status}</div>
                        {pvc.boundTo && <div className="text-green-700 dark:text-green-400 font-mono text-xs mt-2">→ {pvc.boundTo}</div>}
                      </div>
                    </div>
                  ))}
                  {pvcs.length === 0 && <div className="col-span-full text-center text-gray-400 py-12 text-lg">No PVCs created yet</div>}
                </div>
              </div>
            </main>

            {/* Right Panel: Controller + Logs */}
            <aside className="w-full lg:w-96 bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 p-6 overflow-y-auto">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                <RefreshCw className={`w-5 h-5 ${step > 0 && step < 6 ? 'animate-spin text-blue-500' : ''}`} />
                Controller Reconciliation
              </h2>
              <div className="space-y-3 text-sm">
                {["StorageClass", "Access Mode", "Capacity", "Label Selector"].map((label, i) => (
                  <div key={i} className={`flex items-center gap-3 p-3 rounded-lg ${step > i ? 'bg-green-50 dark:bg-green-900/20' : step === i+1 ? 'bg-blue-50 dark:bg-blue-900/30 animate-pulse' : 'bg-gray-50 dark:bg-gray-800'}`}>
                    {step > i ? <CheckCircle2 className="w-5 h-5 text-green-600" /> : step === i+1 ? <RefreshCw className="w-5 h-5 text-blue-600 animate-spin" /> : <div className="w-5 h-5 rounded-full border-2 border-gray-300" />}
                    <span className={step > i ? "font-medium" : ""}>{label} Match</span>
                  </div>
                ))}
              </div>

              {pv?.status === "Released" && (
                <div className="mt-6 p-4 bg-amber-100 dark:bg-amber-900/30 border border-amber-400 rounded-lg">
                  <strong className="flex items-center gap-2"><AlertCircle className="w-5 h-5" /> Binding Blocked</strong>
                  <p className="text-xs mt-2">PV is Released but still references deleted PVC. Requires manual admin intervention.</p>
                </div>
              )}

              <div className="mt-8">
                <h3 className="font-bold mb-3 text-sm uppercase text-gray-500">Event Log</h3>
                <div className="font-mono text-xs space-y-1 max-h-96 overflow-y-auto bg-gray-50 dark:bg-gray-800 p-3 rounded">
                  {logs.length === 0 && <span className="text-gray-400">Waiting for events...</span>}
                  {logs.map(log => (
                    <div key={log.id} className={log.type === "success" ? "text-green-600" : log.type === "warning" ? "text-amber-600" : ""}>
                      <span className="opacity-60">[{log.time}]</span> {log.msg}
                    </div>
                  ))}
                </div>
              </div>
            </aside>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<K8sStorageSimulator />);
  </script>
</body>
</html>
